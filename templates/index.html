<!DOCTYPE html>
<html>
<head>
    <title>Advanced Data Visualization Tool</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f8f9fa;
        }
        .container {
            max-width: 1400px;
            padding: 20px;
        }
        .card {
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .btn-primary {
            background-color: #4a86e8;
            border-color: #4a86e8;
        }
        .table-responsive {
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="#">Data Visualization Tool</a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="dataSourceDropdown" role="button" data-bs-toggle="dropdown">
                            Data Source
                        </a>
                        <ul class="dropdown-menu" id="dataSourceMenu">
                            <li><a class="dropdown-item" href="#" onclick="loadSampleData()">Sample Data</a></li>
                            <li><hr class="dropdown-divider"></li>
                            {% for source in data_sources %}
                            <li><a class="dropdown-item api-source" href="#" data-source="{{ source }}">{{ source }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="chartTypeDropdown" role="button" data-bs-toggle="dropdown">
                            Chart Type
                        </a>
                        <ul class="dropdown-menu">
                            {% for chart_type in chart_types %}
                            <li><a class="dropdown-item chart-type" href="#" data-type="{{ chart_type }}">{{ chart_type }}</a></li>
                            {% endfor %}
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <div class="container mt-4">
        <div class="row">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Data Controls</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <button class="btn btn-primary" id="refreshData">Refresh Data</button>
                            <button class="btn btn-secondary" id="clearData">Clear Data</button>
                        </div>
                        
                        <div id="apiControls" style="display:none" class="mb-3">
                            <h6>API Settings</h6>
                            <div id="apiParams">
                                <!-- Dynamic API parameters will be inserted here -->
                            </div>
                            <div class="form-check mt-2">
                                <input class="form-check-input" type="checkbox" id="autoRefresh">
                                <label class="form-check-label" for="autoRefresh">
                                    Auto Refresh
                                </label>
                            </div>
                        </div>
                        
                        <div class="mb-3">
                            <h6>Chart Settings</h6>
                            <div class="mb-2">
                                <label for="titleInput" class="form-label">Chart Title</label>
                                <input type="text" class="form-control" id="titleInput" value="Data Visualization Chart">
                            </div>
                            <div class="mb-2">
                                <label for="xAxisInput" class="form-label">X-Axis Label</label>
                                <input type="text" class="form-control" id="xAxisInput" value="X-axis">
                            </div>
                            <div class="mb-2">
                                <label for="yAxisInput" class="form-label">Y-Axis Label</label>
                                <input type="text" class="form-control" id="yAxisInput" value="Values">
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Data Preview</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-sm table-hover" id="dataTable">
                                <thead>
                                    <tr id="tableHeader"></tr>
                                </thead>
                                <tbody id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5 class="card-title mb-0">Data Visualization</h5>
                    </div>
                    <div class="card-body">
                        <div id="chart" style="height: 600px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let currentData = null;
        let currentChartType = 'Line';
        let autoRefreshInterval = null;
        let currentSource = null;
        
        $(document).ready(function() {
            // Load sample data on page load
            loadSampleData();
            
            // Set up event listeners
            $('.chart-type').click(function() {
                currentChartType = $(this).data('type');
                $('#chartTypeDropdown').text(currentChartType);
                updateChart();
            });
            
            $('.api-source').click(function() {
                currentSource = $(this).data('source');
                $('#dataSourceDropdown').text(currentSource);
                loadApiData(currentSource);
            });
            
            $('#refreshData').click(function() {
                if (currentSource) {
                    loadApiData(currentSource);
                } else {
                    loadSampleData();
                }
            });
            
            $('#clearData').click(function() {
                clearData();
            });
            
            $('#autoRefresh').change(function() {
                if ($(this).is(':checked')) {
                    startAutoRefresh();
                } else {
                    stopAutoRefresh();
                }
            });
            
            // Chart settings
            $('#titleInput, #xAxisInput, #yAxisInput').change(function() {
                updateChart();
            });
        });
        
        function loadSampleData() {
            currentSource = null;
            $('#dataSourceDropdown').text('Sample Data');
            $('#apiControls').hide();
            
            $.getJSON('/get-sample-data', function(response) {
                currentData = response.data;
                updateTable(response.data, response.columns);
                updateChart();
            });
        }
        
        function loadApiData(source) {
            $('#apiControls').show();
            
            $.ajax({
                url: '/api-data',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({source: source}),
                success: function(response) {
                    if (response.error) {
                        alert('Error: ' + response.error);
                        return;
                    }
                    
                    // Simple display of API params (can be improved)
                    let paramsHtml = '';
                    for (const [key, value] of Object.entries(response.config.params)) {
                        paramsHtml += `
                            <div class="mb-2">
                                <label for="${key}Input" class="form-label">${key}</label>
                                <input type="text" class="form-control apiParam" id="${key}Input" 
                                       data-param="${key}" value="${value}">
                            </div>
                        `;
                    }
                    $('#apiParams').html(paramsHtml);
                    
                    // Process the data based on the configuration
                    // This is simplified - you'd want to do more processing here
                    processApiData(response.data, response.config);
                }
            });
        }
        
        function processApiData(data, config) {
            // This is a simplified version of your Python processing function
            // In a real app, you might want to move this logic to the server side
            
            let processedData = [];
            let columns = [config.x_field];
            
            // Add y field column names
            config.y_fields.forEach(field => {
                let fieldName = field.split('.').pop();
                columns.push(fieldName);
            });
            
            // Process according to data structure (simplified)
            if (config.data_path) {
                // Navigate to the correct data path
                let path = config.data_path.split('.');
                let currentData = data;
                
                for (let part of path) {
                    currentData = currentData[part];
                }
                
                // Process object data (like time series)
                if (typeof currentData === 'object' && !Array.isArray(currentData)) {
                    for (let key in currentData) {
                        let row = {};
                        row[config.x_field] = key;
                        
                        for (let field of config.y_fields) {
                            let fieldParts = field.split('.');
                            let value = currentData[key];
                            
                            for (let part of fieldParts) {
                                if (value && value[part] !== undefined) {
                                    value = value[part];
                                } else {
                                    value = null;
                                    break;
                                }
                            }
                            
                            let fieldName = fieldParts.pop();
                            row[fieldName] = value ? parseFloat(value) : 0;
                        }
                        
                        processedData.push(row);
                    }
                }
            }
            
            currentData = processedData;
            updateTable(processedData, columns);
            updateChart();
        }
        
        function updateTable(data, columns) {
            // Clear the table
            $('#tableHeader').empty();
            $('#tableBody').empty();
            
            // Add headers
            columns.forEach(col => {
                $('#tableHeader').append(`<th>${col}</th>`);
            });
            
            // Add rows (limit to first 50 for performance)
            const maxRows = Math.min(data.length, 50);
            for (let i = 0; i < maxRows; i++) {
                let row = '<tr>';
                columns.forEach(col => {
                    row += `<td>${data[i][col]}</td>`;
                });
                row += '</tr>';
                $('#tableBody').append(row);
            }
        }
        
        function updateChart() {
            if (!currentData || currentData.length === 0) return;
            
            // Get the first row to determine available columns
            const firstRow = currentData[0];
            const columns = Object.keys(firstRow);
            
            // Default X column is the first column
            const xColumn = columns[0];
            
            // Y columns are all numeric columns except the X column
            const yColumns = columns.slice(1).filter(col => 
                !isNaN(parseFloat(firstRow[col]))
            );
            
            $.ajax({
                url: '/create-chart',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({
                    chart_type: currentChartType,
                    data: currentData,
                    x_column: xColumn,
                    y_columns: yColumns,
                    title: $('#titleInput').val(),
                    x_axis: $('#xAxisInput').val(),
                    y_axis: $('#yAxisInput').val()
                }),
                success: function(response) {
                    const figure = JSON.parse(response.chart);
                    Plotly.react('chart', figure.data, figure.layout);
                }
            });
        }
        
        function clearData() {
            currentData = [];
            $('#tableHeader').empty();
            $('#tableBody').empty();
            Plotly.purge('chart');
        }
        
        function startAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
            }
            
            autoRefreshInterval = setInterval(function() {
                if (currentSource) {
                    loadApiData(currentSource);
                }
            }, 30000); // 30 seconds
        }
        
        function stopAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
            }
        }
    </script>
</body>
</html> 